name: æŒç»­é›†æˆ

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  BUILD_CONFIGURATION: Debug
  PROJECT_NAME: TinyPin

jobs:
  build-test:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, Win32, ARM64]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: mkdir -p build/compile/Debug/${{ matrix.platform }}

    - name: æ„å»º ${{ matrix.platform }} ç‰ˆæœ¬
      run: |
        msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ matrix.platform }} /p:OutDir="build\compile\Debug\${{ matrix.platform }}\" /nologo /verbosity:minimal

    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        $platform = "${{ matrix.platform }}"
        $exePath = "build\compile\Debug\$platform\TinyPin.exe"
        
        if (Test-Path $exePath) {
          $size = (Get-Item $exePath).Length
          Write-Host "âœ“ $platform ç‰ˆæœ¬æ„å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºæœ‰æ•ˆçš„PEæ–‡ä»¶
          $header = Get-Content $exePath -Encoding Byte -TotalCount 2
          if ($header[0] -eq 77 -and $header[1] -eq 90) {  # MZ header
            Write-Host "âœ“ $platform ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼æ­£ç¡®"
          } else {
            Write-Error "âœ— $platform ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼é”™è¯¯"
            exit 1
          }
        } else {
          Write-Error "âœ— $platform ç‰ˆæœ¬æ„å»ºå¤±è´¥ï¼Œå¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
          exit 1
        }

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TinyPin-Debug-${{ matrix.platform }}
        path: build/compile/Debug/${{ matrix.platform }}/TinyPin.exe
        retention-days: 7

  code-quality:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      shell: pwsh
      run: |
        Write-Host "ğŸ” æ£€æŸ¥ä»£ç æ ¼å¼..."
        
        # æ£€æŸ¥æ–‡ä»¶ç¼–ç ï¼ˆåº”ä¸ºUTF-8æ— BOMï¼‰
        $files = Get-ChildItem -Path "src", "include" -Recurse -Include "*.cpp", "*.h"
        $encodingIssues = @()
        
        foreach ($file in $files) {
          $content = Get-Content $file.FullName -Raw -Encoding Byte
          if ($content.Length -ge 3 -and $content[0] -eq 0xEF -and $content[1] -eq 0xBB -and $content[2] -eq 0xBF) {
            $encodingIssues += $file.FullName
          }
        }
        
        if ($encodingIssues.Count -gt 0) {
          Write-Warning "ä»¥ä¸‹æ–‡ä»¶åŒ…å«BOMï¼Œåº”ä½¿ç”¨UTF-8æ— BOMæ ¼å¼ï¼š"
          $encodingIssues | ForEach-Object { Write-Warning "  - $_" }
        } else {
          Write-Host "âœ“ æ‰€æœ‰æºæ–‡ä»¶ç¼–ç æ ¼å¼æ­£ç¡®"
        }
        
        # æ£€æŸ¥è¡Œå°¾æ ¼å¼ï¼ˆåº”ä¸ºLFï¼‰
        $crlfFiles = @()
        foreach ($file in $files) {
          $content = Get-Content $file.FullName -Raw
          if ($content -match "`r`n") {
            $crlfFiles += $file.FullName
          }
        }
        
        if ($crlfFiles.Count -gt 0) {
          Write-Warning "ä»¥ä¸‹æ–‡ä»¶ä½¿ç”¨CRLFè¡Œå°¾ï¼Œåº”ä½¿ç”¨LFï¼š"
          $crlfFiles | ForEach-Object { Write-Warning "  - $_" }
        } else {
          Write-Host "âœ“ æ‰€æœ‰æºæ–‡ä»¶è¡Œå°¾æ ¼å¼æ­£ç¡®"
        }

    - name: é¡¹ç›®ç»“æ„æ£€æŸ¥
      shell: pwsh
      run: |
        Write-Host "ğŸ—ï¸ æ£€æŸ¥é¡¹ç›®ç»“æ„..."
        
        # æ£€æŸ¥å¿…è¦çš„ç›®å½•ç»“æ„
        $requiredDirs = @("src", "include", "assets", "resources", "tools")
        $missingDirs = @()
        
        foreach ($dir in $requiredDirs) {
          if (-not (Test-Path $dir)) {
            $missingDirs += $dir
          }
        }
        
        if ($missingDirs.Count -gt 0) {
          Write-Error "ç¼ºå°‘å¿…è¦çš„ç›®å½•ï¼š"
          $missingDirs | ForEach-Object { Write-Error "  - $_" }
          exit 1
        } else {
          Write-Host "âœ“ é¡¹ç›®ç›®å½•ç»“æ„å®Œæ•´"
        }
        
        # æ£€æŸ¥å…³é”®æ–‡ä»¶
        $requiredFiles = @(
          "TinyPin.sln",
          "TinyPin.vcxproj", 
          "LICENSE.txt",
          "README.md",
          "tools/Scripts/TinyPin.iss",
          "tools/Scripts/build.bat"
        )
        
        $missingFiles = @()
        foreach ($file in $requiredFiles) {
          if (-not (Test-Path $file)) {
            $missingFiles += $file
          }
        }
        
        if ($missingFiles.Count -gt 0) {
          Write-Error "ç¼ºå°‘å¿…è¦çš„æ–‡ä»¶ï¼š"
          $missingFiles | ForEach-Object { Write-Error "  - $_" }
          exit 1
        } else {
          Write-Host "âœ“ å…³é”®æ–‡ä»¶å®Œæ•´"
        }

  summary:
    runs-on: windows-latest
    needs: [build-test, code-quality]
    if: always()
    
    steps:
    - name: CIç»“æœæ±‡æ€»
      shell: pwsh
      run: |
        $buildResult = "${{ needs.build-test.result }}"
        $qualityResult = "${{ needs.code-quality.result }}"
        
        Write-Host "ğŸ“Š CI æ‰§è¡Œç»“æœæ±‡æ€»"
        Write-Host "===================="
        Write-Host "æ„å»ºæµ‹è¯•: $buildResult"
        Write-Host "ä»£ç è´¨é‡: $qualityResult"
        Write-Host ""
        
        if ($buildResult -eq "success" -and $qualityResult -eq "success") {
          Write-Host "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ä»£ç å¯ä»¥åˆå¹¶åˆ° release åˆ†æ”¯"
          exit 0
        } else {
          Write-Host "âŒ å­˜åœ¨é—®é¢˜ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤"
          exit 1
        }