name: æ‰‹åŠ¨å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.1)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

env:
  BUILD_CONFIGURATION: Release
  PROJECT_NAME: TinyPin

jobs:
  manual-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: éªŒè¯ç‰ˆæœ¬æ ¼å¼
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        if ($version -notmatch '^\d+\.\d+\.\d+$') {
          Write-Error "ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º x.y.z æ ¼å¼ï¼Œä¾‹å¦‚: 1.0.1"
          exit 1
        }
        echo "âœ“ ç‰ˆæœ¬å·æ ¼å¼æ­£ç¡®: $version"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        mkdir -p build/compile/Release/x64
        mkdir -p build/compile/Release/Win32
        mkdir -p build/compile/Release/ARM64
        mkdir -p build/installer

    - name: æ„å»ºæ‰€æœ‰å¹³å°
      shell: pwsh
      run: |
        $platforms = @("x64", "Win32", "ARM64")
        
        foreach ($platform in $platforms) {
          Write-Host "ğŸ”¨ æ„å»º $platform ç‰ˆæœ¬..."
          msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=$platform /p:OutDir="build\compile\Release\$platform\" /nologo /verbosity:minimal
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "$platform ç‰ˆæœ¬æ„å»ºå¤±è´¥"
            exit 1
          }
          
          $exePath = "build\compile\Release\$platform\TinyPin.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length
            Write-Host "âœ“ $platform ç‰ˆæœ¬æ„å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
          } else {
            Write-Error "$platform ç‰ˆæœ¬å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            exit 1
          }
        }

    - name: åˆ›å»ºæ‰€æœ‰å®‰è£…åŒ…
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        $platforms = @("x64", "Win32", "arm64")
        $isccPath = "tools\InnoSetup6\ISCC.exe"
        $scriptPath = "tools\Scripts\TinyPin.iss"
        $outputDir = "build\installer"
        
        foreach ($platform in $platforms) {
          Write-Host "ğŸ“¦ åˆ›å»º $platform å®‰è£…åŒ…..."
          $sourcePath = "build\compile\Release\$platform\TinyPin.exe"
          
          & $isccPath $scriptPath /Dp=$platform /Ds=$sourcePath /Do=$outputDir /Dv=$version
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "$platform å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
            exit 1
          }
          
          $installerPath = "$outputDir\TinyPin-$version-$platform-setup.exe"
          if (Test-Path $installerPath) {
            $size = (Get-Item $installerPath).Length
            Write-Host "âœ“ $platform å®‰è£…åŒ…åˆ›å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
          } else {
            Write-Error "$platform å®‰è£…åŒ…æ–‡ä»¶æœªæ‰¾åˆ°"
            exit 1
          }
        }

    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
      id: release_notes
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        $date = Get-Date -Format "yyyyå¹´MMæœˆddæ—¥"
        $prerelease = "${{ github.event.inputs.prerelease }}" -eq "true"
        $prereleaseText = if ($prerelease) { " (é¢„å‘å¸ƒç‰ˆæœ¬)" } else { "" }
        
        $releaseNotes = @"
        ## TinyPin $version$prereleaseText

        **å‘å¸ƒæ—¥æœŸ**: $date

        ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

        - **TinyPin-$version-x64-setup.exe** - é€‚ç”¨äº 64 ä½ Windows ç³»ç»Ÿ
        - **TinyPin-$version-Win32-setup.exe** - é€‚ç”¨äº 32 ä½å’Œ 64 ä½ Windows ç³»ç»Ÿ
        - **TinyPin-$version-arm64-setup.exe** - é€‚ç”¨äº ARM64 Windows ç³»ç»Ÿ

        ### ğŸ”§ ç³»ç»Ÿè¦æ±‚

        - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
        - å¯¹åº”çš„ç³»ç»Ÿæ¶æ„ (x64/x86/ARM64)

        ### ğŸ“ æ›´æ–°å†…å®¹

        æ­¤ç‰ˆæœ¬é€šè¿‡æ‰‹åŠ¨å‘å¸ƒæµç¨‹åˆ›å»ºï¼ŒåŒ…å«æœ€æ–°çš„åŠŸèƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤ã€‚

        ### ğŸš€ å®‰è£…è¯´æ˜

        1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿæ¶æ„çš„å®‰è£…åŒ…
        2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
        3. å®‰è£…å®Œæˆåå¯åœ¨å¼€å§‹èœå•æ‰¾åˆ° TinyPin

        ---
        
        **é¡¹ç›®ä¸»é¡µ**: https://github.com/${{ github.repository }}
        "@
        
        $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
        echo "notes_file=release_notes.md" >> $env:GITHUB_OUTPUT

    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: TinyPin ${{ github.event.inputs.version }}
        body_path: ${{ steps.release_notes.outputs.notes_file }}
        draft: false
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          build/installer/TinyPin-${{ github.event.inputs.version }}-x64-setup.exe
          build/installer/TinyPin-${{ github.event.inputs.version }}-Win32-setup.exe
          build/installer/TinyPin-${{ github.event.inputs.version }}-arm64-setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: å‘å¸ƒå®Œæˆé€šçŸ¥
      shell: pwsh
      run: |
        $version = "${{ github.event.inputs.version }}"
        $prerelease = "${{ github.event.inputs.prerelease }}" -eq "true"
        $prereleaseText = if ($prerelease) { " (é¢„å‘å¸ƒç‰ˆæœ¬)" } else { "" }
        
        Write-Host "ğŸ‰ TinyPin $version$prereleaseText æ‰‹åŠ¨å‘å¸ƒå®Œæˆï¼"
        Write-Host ""
        Write-Host "ğŸ“¦ ç”Ÿæˆçš„å®‰è£…åŒ…ï¼š"
        Get-ChildItem "build\installer\*.exe" | ForEach-Object {
          $size = [math]::Round($_.Length/1MB, 2)
          Write-Host "  - $($_.Name) ($size MB)"
        }
        Write-Host ""
        Write-Host "ğŸš€ å·²å‘å¸ƒåˆ° GitHub Releases: v$version"
        Write-Host "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/v$version"