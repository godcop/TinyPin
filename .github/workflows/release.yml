name: è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ release ]
  pull_request:
    branches: [ release ]

env:
  # æ„å»ºé…ç½®
  BUILD_CONFIGURATION: Release
  # é¡¹ç›®åç§°
  PROJECT_NAME: TinyPin

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      shell: pwsh
      run: |
        # ä»gitæ ‡ç­¾è·å–ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰æ ‡ç­¾åˆ™ä½¿ç”¨æ—¥æœŸ
        $tag = git describe --tags --abbrev=0 2>$null
        if ($tag) {
          $version = $tag -replace '^v', ''
        } else {
          $version = "1.0.$(Get-Date -Format 'yyyyMMdd')"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=v$version" >> $env:GITHUB_OUTPUT
        echo "æ„å»ºç‰ˆæœ¬: $version"

    - name: åˆ›å»ºæ„å»ºç›®å½•
      run: |
        mkdir -p build/compile/Release/x64
        mkdir -p build/compile/Release/Win32
        mkdir -p build/compile/Release/ARM64
        mkdir -p build/installer

    - name: æ„å»º x64 ç‰ˆæœ¬
      run: |
        msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=x64 /p:OutDir="build\compile\Release\x64\" /nologo /verbosity:minimal

    - name: æ„å»º Win32 ç‰ˆæœ¬
      run: |
        msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=Win32 /p:OutDir="build\compile\Release\Win32\" /nologo /verbosity:minimal

    - name: æ„å»º ARM64 ç‰ˆæœ¬
      run: |
        msbuild TinyPin.sln /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=ARM64 /p:OutDir="build\compile\Release\ARM64\" /nologo /verbosity:minimal

    - name: éªŒè¯æ„å»ºç»“æœ
      shell: pwsh
      run: |
        $platforms = @("x64", "Win32", "ARM64")
        foreach ($platform in $platforms) {
          $exePath = "build\compile\Release\$platform\TinyPin.exe"
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length
            Write-Host "âœ“ $platform ç‰ˆæœ¬æ„å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
          } else {
            Write-Error "âœ— $platform ç‰ˆæœ¬æ„å»ºå¤±è´¥"
            exit 1
          }
        }

    - name: åˆ›å»º x64 å®‰è£…åŒ…
      shell: pwsh
      run: |
        $isccPath = "tools\InnoSetup6\ISCC.exe"
        $scriptPath = "tools\Scripts\TinyPin.iss"
        $sourcePath = "build\compile\Release\x64\TinyPin.exe"
        $outputDir = "build\installer"
        
        & $isccPath $scriptPath /Dp=x64 /Ds=$sourcePath /Do=$outputDir /Dv=${{ steps.version.outputs.version }}
        if ($LASTEXITCODE -ne 0) {
          Write-Error "x64 å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }

    - name: åˆ›å»º Win32 å®‰è£…åŒ…
      shell: pwsh
      run: |
        $isccPath = "tools\InnoSetup6\ISCC.exe"
        $scriptPath = "tools\Scripts\TinyPin.iss"
        $sourcePath = "build\compile\Release\Win32\TinyPin.exe"
        $outputDir = "build\installer"
        
        & $isccPath $scriptPath /Dp=Win32 /Ds=$sourcePath /Do=$outputDir /Dv=${{ steps.version.outputs.version }}
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Win32 å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }

    - name: åˆ›å»º ARM64 å®‰è£…åŒ…
      shell: pwsh
      run: |
        $isccPath = "tools\InnoSetup6\ISCC.exe"
        $scriptPath = "tools\Scripts\TinyPin.iss"
        $sourcePath = "build\compile\Release\ARM64\TinyPin.exe"
        $outputDir = "build\installer"
        
        & $isccPath $scriptPath /Dp=arm64 /Ds=$sourcePath /Do=$outputDir /Dv=${{ steps.version.outputs.version }}
        if ($LASTEXITCODE -ne 0) {
          Write-Error "ARM64 å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }

    - name: éªŒè¯å®‰è£…åŒ…
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $platforms = @("x64", "Win32", "arm64")
        $installers = @()
        
        foreach ($platform in $platforms) {
          $installerPath = "build\installer\TinyPin-$version-$platform-setup.exe"
          if (Test-Path $installerPath) {
            $size = (Get-Item $installerPath).Length
            Write-Host "âœ“ $platform å®‰è£…åŒ…åˆ›å»ºæˆåŠŸ (å¤§å°: $([math]::Round($size/1MB, 2)) MB)"
            $installers += $installerPath
          } else {
            Write-Error "âœ— $platform å®‰è£…åŒ…åˆ›å»ºå¤±è´¥"
            exit 1
          }
        }
        
        # å°†å®‰è£…åŒ…è·¯å¾„ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
        $installersJson = $installers | ConvertTo-Json -Compress
        echo "INSTALLERS=$installersJson" >> $env:GITHUB_ENV

    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
      id: release_notes
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        $date = Get-Date -Format "yyyyå¹´MMæœˆddæ—¥"
        
        $releaseNotes = @"
        ## TinyPin $version å‘å¸ƒ

        **å‘å¸ƒæ—¥æœŸ**: $date

        ### ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

        - **TinyPin-$version-x64-setup.exe** - é€‚ç”¨äº 64 ä½ Windows ç³»ç»Ÿ
        - **TinyPin-$version-Win32-setup.exe** - é€‚ç”¨äº 32 ä½å’Œ 64 ä½ Windows ç³»ç»Ÿ
        - **TinyPin-$version-arm64-setup.exe** - é€‚ç”¨äº ARM64 Windows ç³»ç»Ÿ

        ### ğŸ”§ ç³»ç»Ÿè¦æ±‚

        - Windows 7 SP1 æˆ–æ›´é«˜ç‰ˆæœ¬
        - å¯¹åº”çš„ç³»ç»Ÿæ¶æ„ (x64/x86/ARM64)

        ### ğŸ“ æ›´æ–°å†…å®¹

        æ­¤ç‰ˆæœ¬åŒ…å«æœ€æ–°çš„åŠŸèƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤ã€‚

        ### ğŸš€ å®‰è£…è¯´æ˜

        1. ä¸‹è½½é€‚åˆæ‚¨ç³»ç»Ÿæ¶æ„çš„å®‰è£…åŒ…
        2. è¿è¡Œå®‰è£…ç¨‹åºå¹¶æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
        3. å®‰è£…å®Œæˆåå¯åœ¨å¼€å§‹èœå•æ‰¾åˆ° TinyPin

        ---
        
        **å®Œæ•´æ›´æ”¹æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/v$version...release
        "@
        
        # å°†å‘å¸ƒè¯´æ˜ä¿å­˜åˆ°æ–‡ä»¶
        $releaseNotes | Out-File -FilePath "release_notes.md" -Encoding UTF8
        echo "notes_file=release_notes.md" >> $env:GITHUB_OUTPUT

    - name: åˆ›å»º GitHub Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/release'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: TinyPin ${{ steps.version.outputs.version }}
        body_path: ${{ steps.release_notes.outputs.notes_file }}
        draft: false
        prerelease: false
        files: |
          build/installer/TinyPin-${{ steps.version.outputs.version }}-x64-setup.exe
          build/installer/TinyPin-${{ steps.version.outputs.version }}-Win32-setup.exe
          build/installer/TinyPin-${{ steps.version.outputs.version }}-arm64-setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: TinyPin-${{ steps.version.outputs.version }}-Installers
        path: |
          build/installer/*.exe
        retention-days: 30

    - name: æ„å»ºå®Œæˆé€šçŸ¥
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.version }}"
        Write-Host "ğŸ‰ TinyPin $version æ„å»ºå®Œæˆï¼"
        Write-Host ""
        Write-Host "ğŸ“¦ ç”Ÿæˆçš„å®‰è£…åŒ…ï¼š"
        Get-ChildItem "build\installer\*.exe" | ForEach-Object {
          $size = [math]::Round($_.Length/1MB, 2)
          Write-Host "  - $($_.Name) ($size MB)"
        }
        
        if ("${{ github.event_name }}" -eq "push" -and "${{ github.ref }}" -eq "refs/heads/release") {
          Write-Host ""
          Write-Host "ğŸš€ å·²è‡ªåŠ¨å‘å¸ƒåˆ° GitHub Releases: ${{ steps.version.outputs.tag }}"
          Write-Host "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}"
        }